{#*
* general_readings general_readings.html.twig
*
* @package   OpenEMR
* @link      http://www.open-emr.org
* @author    Stephen Nielson <stephen@nielson.org>
* @copyright Copyright (c) 2021 Stephen Nielson <stephen@nielson.org>
* @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
*#}
<html>
<head>
    <title>{{ "General Readings"|xlt }}</title>
    {{ setupHeader(["datetime-picker"]) }}
    <style>
        .graph {
            color: #0000cc;
            cursor: pointer;
        }
        .graph:hover {
            color: #ff5555;
        }
    </style>
</head>
<body class="body_top">

{% if is_trend_view %}
    {# Trend view - show historical data table like vitals #}
    {% if _GET.error %}
        <div class="alert alert-danger" style="margin: 20px; padding: 15px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;">
            {{ _GET.error|attr }}
        </div>
    {% endif %}
    {% if _GET.success %}
        <div class="alert alert-success" style="margin: 20px; padding: 15px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;">
            {{ _GET.success|attr }}
        </div>
    {% endif %}
    
    <div class="container mt-3">
        <div class="row no-gutters">
            <div class="col-4">
                <h2 class="h2-responsive">
                    {{ "General Readings"|xlt }}&nbsp;&nbsp;&nbsp;
                    <a id="general-readings-screen-top" href="../summary/demographics.php" class="text-decoration-none" onclick="window.top.restoreSession()"
                        title="{{ 'Back to patient dashboard'|xla }}">
                            <i id="advanced-tooltip" class="readonly fas fa-arrow-circle-left fa-2x small" aria-hidden="true"></i>
                    </a>
                </h2>
            </div>
        </div>
        
        <div id="chart" class="chart-dygraphs" style="margin-left: -15px"></div>
        
        {# Delete forms for each entry - outside main form to avoid conflicts #}
        {% for reading in general_readings_data %}
            <form id="deleteForm{{ reading.id }}" method="post" action="{{ FORM_ACTION|attr }}/interface/forms/general_readings/delete.php" style="display: none;" onsubmit="return confirm('{{ 'Are you sure you want to delete this entry?'|xlt }}')">
                <input type="hidden" name="csrf_token_form" value="{{ CSRF_TOKEN_FORM|attr }}">
                <input type="hidden" name="id" value="{{ reading.id|attr }}">
            </form>
        {% endfor %}
        
        {# Form to add new general readings #}
        <form id="generalReadingsForm" name="general_readings" method="post" action="{{ FORM_ACTION|attr }}/interface/forms/general_readings/save.php">
            <input type="hidden" name="csrf_token_form" value="{{ CSRF_TOKEN_FORM|attr }}" />
            <input type="hidden" name="id" id='id' value="0" />
            <input type="hidden" name="pid" id='pid' value="{{ GLOBALS['pid'] }}" />
            <input type="hidden" name="process" id='process' value="true" />
            
            <div class="table-responsive">
                <table class="table">
                    <thead class="table-head">
                        <tr>
                            <th class="text-left"><span class="general-readings-title">{{ "Name"|xlt }}</span></th>
                            <th class="text-left">{{ "Unit"|xlt }}</th>
                            <th class="currentvalues">{{ "Value"|xlt }}</th>
                            {% for reading in general_readings_data %}
                                <th class='historicalvalues d-none d-md-table-cell'>
                                    {{ reading.date|date("Y-m-d H:i")|text }}
                                    <br>
                                    <button type="button" class="btn btn-danger btn-sm" style="font-size: 10px; padding: 2px 6px;" onclick="document.getElementById('deleteForm{{ reading.id }}').submit();">{{ "Delete"|xlt }}</button>
                                </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {# Use the same pattern as vitals - iterate through fields array #}
                        {% for field in generalReadingsFields %}
                            {% if field.type == "textbox" %}
                                {% include "general_readings_textbox.html.twig" with {
                                    field: field, 
                                    general_readings_data: general_readings_data, 
                                    is_edit: is_edit 
                                } %}
                            {% endif %}
                        {% endfor %}
                        
                        {# PDF Export row like vitals #}
                        <tr>
                            <td>General Readings Report (PDF) General Readings Report (HTML)</td>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm" onclick="window.open('{{ FORM_ACTION|attr }}/interface/forms/general_readings/report.php?pid={{ GLOBALS['pid'] }}&format=pdf', '_blank')">General Readings Report (PDF)</button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="window.open('{{ FORM_ACTION|attr }}/interface/forms/general_readings/report.php?pid={{ GLOBALS['pid'] }}&format=html', '_blank')">General Readings Report (HTML)</button>
                            </td>
                            <td></td>
                            {% for reading in general_readings_data %}
                                <td class="historicalvalues d-none d-md-table-cell"></td>
                            {% endfor %}
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="form-group">
                <div class="text-left position-override">
                    <div class="btn-group" role="group">
                        <button type="submit" class="btn btn-primary btn-save editonly" name="Submit" value=''>{{ "Save"|xlt }}</button>
                        <button type="button" class="btn btn-secondary btn-cancel editonly" id="cancel" value=''>{{ "Cancel"|xlt }}</button>
                    </div>
                </div>
            </div>
        </form>
    </div>
{% else %}
    {# Regular form view #}
    {% if _GET.error %}
        <div class="alert alert-danger" style="margin: 20px; padding: 15px; background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; border-radius: 4px;">
            {{ _GET.error|attr }}
        </div>
    {% endif %}
    {% if _GET.success %}
        <div class="alert alert-success" style="margin: 20px; padding: 15px; background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; border-radius: 4px;">
            {{ _GET.success|attr }}
        </div>
    {% endif %}
    
    <form method="post" action="{{ FORM_ACTION|attr }}/interface/forms/general_readings/save.php" onsubmit="return top.restoreSession()">
        <input type="hidden" name="csrf_token_form" value="{{ CSRF_TOKEN_FORM|attr }}">
        <input type="hidden" name="id" value="{{ general_readings.id|attr }}">
        
        <div class="container">
            <h2>{{ "General Readings"|xlt }}</h2>
            
            <table class="table">
                <tr>
                    <td>{{ "Daily Fluid Intake (ml)"|xlt }}:</td>
                    <td><input type="number" name="daily_fluid_intake" value="{{ general_readings.daily_fluid_intake|attr }}" step="0.01" min="0" max="10000"></td>
                </tr>
                <tr>
                    <td>{{ "Daily Protein Intake (grams)"|xlt }}:</td>
                    <td><input type="number" name="daily_protein_intake" value="{{ general_readings.daily_protein_intake|attr }}" step="0.01" min="0" max="1000"></td>
                </tr>
                <tr>
                    <td>{{ "Shower (0-5)"|xlt }}:</td>
                    <td><input type="number" name="shower" value="{{ general_readings.shower|attr }}" min="0" max="5"></td>
                </tr>
                <tr>
                    <td>{{ "Sponge Bath (0-5)"|xlt }}:</td>
                    <td><input type="number" name="sponge_bath" value="{{ general_readings.sponge_bath|attr }}" min="0" max="5"></td>
                </tr>
                <tr>
                    <td class="graph" id="walking"><span class="general-readings-title">{{ "Walking (0-10)"|xlt }}</span></td>
                    <td><input type="number" name="walking" value="{{ general_readings.walking|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "AM Fasting Glucose (0-30)"|xlt }}:</td>
                    <td><input type="number" name="am_fasting_glucose" value="{{ general_readings.am_fasting_glucose|attr }}" step="0.01" min="0" max="30"></td>
                </tr>
                <tr>
                    <td>{{ "HS Fasting Glucose (0-30)"|xlt }}:</td>
                    <td><input type="number" name="hs_fasting_glucose" value="{{ general_readings.hs_fasting_glucose|attr }}" step="0.01" min="0" max="30"></td>
                </tr>
                <tr>
                    <td>{{ "Energy (0-10)"|xlt }}:</td>
                    <td><input type="number" name="energy" value="{{ general_readings.energy|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Sleep Pattern (0-10)"|xlt }}:</td>
                    <td><input type="number" name="sleep_pattern" value="{{ general_readings.sleep_pattern|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Stress Level/Mood (0-10)"|xlt }}:</td>
                    <td><input type="number" name="stress_level" value="{{ general_readings.stress_level|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Pain (0-10)"|xlt }}:</td>
                    <td><input type="number" name="pain" value="{{ general_readings.pain|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Abdominal Pain (0-10)"|xlt }}:</td>
                    <td><input type="number" name="abdominal_pain" value="{{ general_readings.abdominal_pain|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Appetite (0-10)"|xlt }}:</td>
                    <td><input type="number" name="appetite" value="{{ general_readings.appetite|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Bowel Movements (0-10)"|xlt }}:</td>
                    <td><input type="number" name="bowel_movements" value="{{ general_readings.bowel_movements|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Fatigue (0-10)"|xlt }}:</td>
                    <td><input type="number" name="fatigue" value="{{ general_readings.fatigue|attr }}" min="0" max="10"></td>
                </tr>
                <tr>
                    <td>{{ "Notes"|xlt }}:</td>
                    <td><textarea name="note" rows="3" cols="50">{{ general_readings.note|attr }}</textarea></td>
                </tr>
            </table>
            
            <div class="form-actions">
                <input type="submit" value="{{ "Save"|xlt }}" class="btn btn-primary">
                <a href="{{ DONT_SAVE_LINK|attr }}" class="btn btn-secondary">{{ "Cancel"|xlt }}</a>
            </div>
        </div>
    </form>
{% endif %}

</body>
</html>